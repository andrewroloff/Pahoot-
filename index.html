<!-- index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <title>Pahoot!</title>
    <style>
        /* csstop */
        :root {
            --radius-lg: 22px;
            --radius-md: 16px;
            --pad-lg: 28px;
            --pad-md: 20px;
            --pad-sm: 14px;

            --glass-bg: rgba(15, 15, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.15);
        }

        body {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 900 !important;
            background: #0B486B;
            background: linear-gradient(5deg,
                    #0B486B, #F56217);
            margin: 0;
            padding: 0;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* themes */

        body.theme-eepy {
            background: url("https://media.istockphoto.com/id/486866710/photo/man-in-pajamas.jpg?s=170667a&w=is&k=20&c=jajdSFUpCau6O6YNdESD6yn76C7NokAdXT19fJjcCZI=");
            background-size: 15%;
        }

        .pjhat {
            display: none;
        }

        .theme-eepy .pjhat {
            display: inherit !important;
            width: 120px;
            Position: absolute;
            left: 90px;
            top: 5px;
            rotate: -15deg;
        }

        body.theme-fire {
            background: url("https://i.pinimg.com/originals/f9/6d/fb/f96dfb9f9d4e0b42af3888de8b9473a7.gif");
            background-repeat: none;
            background-size: cover;
        }

        .theme-fire .red {
            background: #f05a31;
        }

        .theme-fire .blue {
            background: #d04419;
        }

        .theme-fire .green {
            background: #faf055;
        }

        .theme-fire .yellow {
            background: #ca2210;
        }

        body.theme-diamond {
            background: url("https://i.pinimg.com/originals/eb/3d/2d/eb3d2d44ebbe7a6bb8b9d3768846e875.gif");
            background-size: 249px 140px;
        }

        .theme-diamond .red {
            background: #1f75e4;
        }

        .theme-diamond .blue {
            background: #0e3e7d;
        }

        .theme-diamond .green {
            background: #5599f3;
        }

        .theme-diamond .yellow {
            background: #2c496f;
        }

        body.theme-chaos {
            filter: saturate(140%) contrast(120%);
        }

        body.theme-matrix {
            background: url("https://upload.wikimedia.org/wikipedia/commons/c/cc/Digital_rain_animation_medium_letters_shine.gif");
            color: #00ff88;
        }

        .flashcard {
            width: 100%;
            max-width: 520px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            user-select: none;
        }


        .flashcard-inner {
            position: relative;
            min-height: 260px;
            transition: transform 0.6s cubic-bezier(.4, .2, .2, 1);
            transform-style: preserve-3d;
        }

        .flashcard-stage {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 32px;
            min-height: 360px;
        }


        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            background:
                linear-gradient(160deg, rgba(255, 255, 255, .1), rgba(0, 0, 0, .3)),
                linear-gradient(5deg, #0B486B, #F56217);

            border-radius: var(--radius-lg);
            padding: var(--pad-lg);

            box-shadow:
                0 18px 40px rgba(0, 0, 0, .6),
                inset 0 1px 3px rgba(255, 255, 255, .2);
        }


        .flashcard-front {
            background: linear-gradient(5deg, #0B486B, #F56217);
        }

        .flashcard-back {
            background: linear-gradient(5deg, #1f4037, #99f2c8);
            transform: rotateY(180deg);
        }

        .card-label {
            font-size: 0.75rem;
            opacity: 0.7;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .card-text {
            font-size: 1.6rem;
            line-height: 1.4;
        }

        .gradient-btn {
            margin-top: 16px;
            padding: 10px 18px;
            border-radius: 999px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(5deg, #0B486B, #F56217);
            box-shadow: 0 6px 16px rgba(0, 0, 0, .4);
            transition: transform .15s, opacity .15s;
        }

        .gradient-btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .gradient-btn:active {
            transform: scale(0.96);
        }

        #controlDrawer {
            position: fixed;
            top: 0;
            left: 0;

            width: 380px;
            padding: var(--pad-md);
            border-radius: var(--radius-md);

            background:
                linear-gradient(160deg, rgba(255, 255, 255, .1), rgba(0, 0, 0, .4)),
                var(--glass-bg);

            backdrop-filter: blur(14px);
            border: 1px solid var(--glass-border);

            box-shadow:
                0 25px 60px rgba(0, 0, 0, .6);
        }

        .container-btn {
            padding: 10px 18px;
            border-radius: 999px;
            background: linear-gradient(5deg, #0B486B, #F56217);
            border: none;
            font-weight: bold;
            box-shadow:
                0 8px 20px rgba(0, 0, 0, .5),
                inset 0 1px 2px rgba(255, 255, 255, .25);
        }

        #learnInput {
            width: 100%;
            margin-top: 14px;
            padding: 10px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
        }

        #hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            opacity: 0.85;
            margin-bottom: 10px;
        }

        #hudMeters {
            display: flex;
            gap: 6px;
        }

        .mini {
            width: 40px;
            height: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .mini::after {
            content: "";
            display: block;
            height: 100%;
            width: var(--fill, 0%);
        }

        .mini.brain::after {
            background: linear-gradient(90deg, #00ffcc, #ff0066);
        }

        .mini.streak::after {
            background: linear-gradient(5deg, #0B486B, #F56217);
        }

        #achievementTicker {
            position: fixed;
            display: flex;
            align-items: center;
            bottom: 0;
            width: 100%;
            height: 42px;
            background: rgba(0, 0, 0, .8);
            color: white;
            overflow: hidden;
            z-index: 9999;
        }

        #achievementTrack {
            display: flex;
            gap: 64px;
            padding-left: 100%;
            animation: ticker 30s linear infinite;
            white-space: nowrap;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            opacity: 1;
        }

        .achievement-item.unlocked {
            opacity: 1;
        }

        @keyframes ticker {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-100%);
            }
        }

        @media (hover:hover) {
            .quiz-container:hover {
                box-shadow:
                    0 40px 100px rgba(0, 0, 0, .75),
                    inset 0 1px 3px rgba(255, 255, 255, .2);
            }
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }

            .question {
                font-size: 1.2rem;
                min-height: auto;
            }

            button.answer {
                font-size: 1rem;
                padding: 14px;
            }
        }

        @media (max-width: 600px) {
            .answers {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(4, auto);
            }
        }

        button.answer {
            min-height: 64px;
        }

        input,
        select {
            font-size: 16px;
        }

        body.darkmode {
            background: #0b0b14;
        }

        /* =========================
   MICRO ANIMATIONS
========================= */

        @keyframes popIn {
            from {
                transform: scale(0.7);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }


        .question {
            animation: questionIn 0.35s ease-out;
        }

        @keyframes questionIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        button.answer {
            animation: answerPop 0.25s ease-out;
        }

        @keyframes answerPop {
            from {
                transform: scale(0.96);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Hypermode hover wobble */
        body.hypermode button.answer:hover {
            animation: wobble 0.25s ease-in-out;
        }

        @keyframes wobble {
            0% {
                transform: rotate(0deg) scale(1.03);
            }

            25% {
                transform: rotate(-1deg) scale(1.03);
            }

            50% {
                transform: rotate(1deg) scale(1.03);
            }

            100% {
                transform: rotate(0deg) scale(1.03);
            }
        }


        /* =========================
          VHS HYPERMODE FINAL FORM
        ========================= */

        body.hypermode {
            background: url("https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/a7da136d-c40b-41c4-860d-b12672b16096/ddim2vn-06fc8ade-95d8-4695-8a8e-82deeb9b8c5c.gif?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7InBhdGgiOiIvZi9hN2RhMTM2ZC1jNDBiLTQxYzQtODYwZC1iMTI2NzJiMTYwOTYvZGRpbTJ2bi0wNmZjOGFkZS05NWQ4LTQ2OTUtOGE4ZS04MmRlZWI5YjhjNWMuZ2lmIn1dXSwiYXVkIjpbInVybjpzZXJ2aWNlOmZpbGUuZG93bmxvYWQiXX0.--ZE7ZPTFKpsE-6T_tEMQe8rfhnSvvoEdXo6nmWu2qI") center / cover no-repeat fixed;
        }

        /* VHS chromatic aberration */
        body.hypermode .quiz-container {
            animation: chromaShift 0.12s infinite;
            box-shadow:
                0 0 60px rgba(255, 0, 255, .4),
                0 0 120px rgba(0, 255, 255, .25);
        }

        @keyframes chromaShift {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(1px, -1px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, 1px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        /* CRT scanlines */
        body.hypermode::before {
            content: "";
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(to bottom,
                    rgba(255, 255, 255, 0.04),
                    rgba(255, 255, 255, 0.04) 1px,
                    rgba(0, 0, 0, 0) 2px,
                    rgba(0, 0, 0, 0) 4px);
            animation: scan 0.15s linear infinite;
            pointer-events: none;
            z-index: 999;
        }

        @keyframes scan {
            from {
                background-position-y: 0;
            }

            to {
                background-position-y: 4px;
            }
        }

        /* Hyper title flicker */
        body.hypermode h1 {
            color: #ff4fd8;
            text-shadow:
                0 0 5px #ff4fd8,
                0 0 15px #ff00ff,
                0 0 30px #00ffff;
            animation: flicker 0.12s infinite alternate;
        }

        @keyframes flicker {
            0% {
                opacity: 1;
            }

            20% {
                opacity: 0.85;
            }

            40% {
                opacity: 1;
            }

            60% {
                opacity: 0.7;
            }

            80% {
                opacity: 1;
            }
        }

        /* Hide mascots in Hypermode */
        body.hypermode .snoopy,
        body.hypermode .honse {
            display: none;
        }

        /* VHS vertical tracking roll */
        body.hypermode::marker {
            content: "";
        }

        body.hypermode::selection {
            background: transparent;
        }

        body.hypermode::after {
            animation: trackingRoll 6s infinite linear;
        }

        @keyframes trackingRoll {
            0% {
                transform: translateY(0);
            }

            95% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-100%);
            }
        }

        @keyframes screenTear {
            0% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-8px);
            }

            40% {
                transform: translateX(8px);
            }

            60% {
                transform: translateX(-4px);
            }

            80% {
                transform: translateX(4px);
            }

            100% {
                transform: translateX(0);
            }
        }

        body.screen-tear .quiz-container {
            animation: screenTear 0.2s linear;
        }

        @keyframes wrongGlitch {
            0% {
                filter: blur(0);
            }

            30% {
                filter: blur(2px) hue-rotate(30deg);
            }

            60% {
                filter: blur(1px) hue-rotate(-30deg);
            }

            100% {
                filter: blur(0);
            }
        }

        #achievementBar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.75);
            overflow: hidden;
            z-index: 999;
            height: 42px;
        }

        @keyframes ticker {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-100%);
            }
        }


        body.wrong-glitch .quiz-container {
            animation: wrongGlitch 0.4s ease;
        }

        body.lockin * {
            animation: none !important;
        }

        body.lockin .snoopy,
        body.lockin .honse,
        body.lockin span.slider,
        body.lockin span.mode-label,
        body.lockin #fullscreenBtn,
        body.lockin div#streakMeter,
        body.lockin img {
            display: none !important;
        }

        body.lockin .answer {
            background: white !important;
            color: black important;
        }


        body.lockin #settingsBtn {
            background: black !important;
            color: white !important;
        }


        body.lockin {
            background: #000;
        }


        .quiz-container {
            position: relative;
            max-width: 760px;
            margin: 40px auto;
            padding: var(--pad-lg);
            border-radius: var(--radius-lg);

            background:
                linear-gradient(160deg, rgba(255, 255, 255, .06), rgba(0, 0, 0, .2)),
                var(--glass-bg);

            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);

            box-shadow:
                0 30px 80px rgba(0, 0, 0, .65),
                inset 0 1px 2px rgba(255, 255, 255, .15);

            border: 1px solid var(--glass-border);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 3rem;
        }

        .question {
            font-size: 1.8rem;
            margin-bottom: 10px;
            text-align: center;
            min-height: 80px;
        }

        .answers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 16px;
            height: calc(100% - 160px);
        }

        button.answer {
            width: 100%;
            height: 100%;
            padding: 20px;
            font-size: 1.4rem;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        button.answer:hover {
            transform: scale(1.03);
            opacity: 0.9;
        }

        .red {
            background: #e74c3c;
        }


        .blue {
            background: #3498db;
        }

        .yellow {
            background: #f1c40f;
            color: #000;
        }

        .green {
            background: #2ecc71;
        }

        .hidden {
            display: none !important;
        }

        .result {
            text-align: center;
            font-size: 22px;
            margin-top: 20px;
        }

        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;

            background: rgba(0, 0, 0, .55);
            backdrop-filter: blur(6px);
            z-index: 100;
        }

        .overlay-panel {
            width: min(92vw, 520px);
            padding: var(--pad-lg);
            border-radius: var(--radius-lg);

            background:
                linear-gradient(160deg, rgba(255, 255, 255, .08), rgba(0, 0, 0, .35)),
                var(--glass-bg);

            border: 1px solid var(--glass-border);

            box-shadow:
                0 40px 90px rgba(0, 0, 0, .7),
                inset 0 1px 2px rgba(255, 255, 255, .15);

            animation: popIn .35s ease-out;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: fall 5s linear forwards;
        }


        .snoopy {
            position: absolute;
            left: 0;
            top: 50vh;
        }

        .honse {
            position: absolute;
            right: 0;
            top: 10vh;
        }

        @keyframes fall {
            from {
                transform: translateY(0) rotate(0deg);
            }

            to {
                transform: translateY(110vh) rotate(720deg);
            }
        }

        @keyframes popIn {
            from {
                transform: scale(.92) translateY(20px);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .mode-label {
            opacity: 0.85;
        }

        /* Bubble switch container */
        .bubble-switch {
            position: relative;
            width: 72px;
            height: 36px;
        }

        /* Hide checkbox */
        .bubble-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* Track */
        .slider {
            position: absolute;
            inset: 0;
            border-radius: 999px;
            background: linear-gradient(5deg, #0B486B, #F56217);
            box-shadow:
                inset 0 2px 4px rgba(255, 255, 255, 0.3),
                inset 0 -2px 4px rgba(0, 0, 0, 0.3),
                0 6px 12px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Bubble knob */
        .slider::before {
            content: "";
            position: absolute;
            height: 28px;
            width: 28px;
            left: 4px;
            top: 4px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%,
                    #ffffff,
                    #e6e6e6);
            box-shadow:
                inset 0 2px 4px rgba(255, 255, 255, 0.8),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                0 4px 8px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
        }

        /* Checked state */
        .bubble-switch input:checked+.slider::before {
            transform: translateX(22px);
        }

        button.answer:active {
            transform: scale(0.96);
        }
    </style>
</head>

<body>
    <!-- SOUND EFFECTS -->
    <audio id="hoverSound" src="sounds/hover.wav" preload="auto"></audio>
    <audio id="correctSound" src="sounds/correct.wav" preload="auto"></audio>
    <audio id="wrongSound" src="sounds/wrong.wav" preload="auto"></audio>
    <audio id="confettiSound" src="sounds/confetti.wav" preload="auto"></audio>
    <audio id="toggleSound" src="sounds/toggle.wav" preload="auto"></audio>
    <audio id="endSound" src="sounds/win.wav" preload="auto"></audio>
    <audio id="bassSound" src="sounds/bass.mp3" preload="auto"></audio>

    <div id="settingsOverlay" class="overlay hidden">
        <div style="
        background:#111;
        padding:30px;
        border-radius:16px;
        width:320px;
        text-align:left;
        font-size:14px;
    ">
            <h2 style="text-align:center;margin-top:0;">Settings</h2>

            <label>
                <input type="checkbox" id="hideMascots">
                Hide Mascots
            </label><br><br>

            <label>
                Hypermode Time (seconds)
                <input type="number" id="hyperTime" min="1" max="10" value="3" style="width:100%;margin-top:4px;">
            </label><br><br>

            <label>
                <input type="checkbox" id="darkMode">
                Dark Mode (Non-Hyper)
            </label><br><br>

            <label>
                <input type="checkbox" id="lockinMode">
                Lock-In Mode
            </label><br><br>

            <label>
                <input type="checkbox" id="hideAchievements">
                Hide Achievements Ticker
            </label><br><br>

            <label>
                Theme (Must unlock from achievements!)
                <select id="themeSelect">
                    <option value="default">Default Theme</option>
                </select>
            </label><br><br>

            <label>
                <input type="checkbox" id="voiceMode">
                Voice Mode
            </label><br><br>



            <button id="closeSettings" style="
                width:100%;
                padding:10px;
                border:none;
                border-radius:999px;
                background: #0B486B;
                background: linear-gradient(5deg,
                    #0B486B, #F56217);
                cursor:pointer;">
                Done
            </button>
        </div>
    </div>
    <div id="controlDrawer" class="overlay hidden">
        <div style="
    background:#111;
    padding:30px;
    border-radius:16px;
    width:320px;
    text-align:left;
    font-size:14px;
  ">
            <h2 style="text-align:center;margin-top:0;">Game Controls</h2>

            <label>
                Deck
                <select id="drawerDeckSelect" style="
        width:100%;
        padding:10px;
        margin-top:6px;
        border-radius:999px;
        border:none;
        font-weight:bold;
      ">
                    <!-- populated by JS -->
                </select>
            </label>

            <br><br>

            <hr style="opacity:0.2;margin:16px 0;">

            <div style="font-weight:bold;margin-bottom:6px;">Question Types</div>

            <label>
                <input type="checkbox" id="typeMC" checked>
                Multiple Choice
            </label><br>

            <label>
                <input type="checkbox" id="typeTyped">
                Typed Answer
            </label><br>

            <label>
                <input type="checkbox" id="typeTF">
                True / False
            </label>


            <div class="mode-toggle">
                <span class="mode-label">Normal</span>

                <label class="bubble-switch">
                    <input type="checkbox" id="drawerEndlessToggle">
                    <span class="slider"></span>
                </label>

                <span class="mode-label">Endless</span>

                <label class="bubble-switch">
                    <input type="checkbox" id="drawerHyperToggle">
                    <span class="slider"></span>
                </label>

                <span class="mode-label">Hyper</span>
            </div>

            <br>

            <button id="drawerFullscreenBtn" style="
      width:100%;
      padding:10px;
      border:none;
      border-radius:999px;
      background:linear-gradient(5deg,#0B486B,#F56217);
      font-weight:bold;
      cursor:pointer;
    ">
                ‚õ∂ Fullscreen
            </button>

            <br><br>

            <button id="closeDrawer" style="
      width:100%;
      padding:10px;
      border:none;
      border-radius:999px;
        background: #0B486B;
                background: linear-gradient(5deg,
                    #0B486B, #F56217);      cursor:pointer;
    ">
                Done
            </button>
        </div>
    </div>

    <div id="flashcardOverlay" class="overlay hidden">
        <div class="flashcard-container">

            <div class="flashcard-controls">
                <button onclick="exitFlashcards()" style="
        border:none;
        border-radius:50%;
        width:42px;
        height:42px;
        font-size:20px;
        cursor:pointer;
        background: #0B486B;
            background: linear-gradient(5deg,
                    #0B486B, #F56217);
        color:black;">‚úï</button>
                <button onclick="setFlashcardMode('carousel')" style="
  width:100px;
  padding:10px;
  margin-top:10px;
  margin-bottom:10px;
  border-radius:999px;
  border:none;
  background: #F56217;
  cursor:pointer;
  font-weight:bold;">Carousel</button>
                <button onclick="setFlashcardMode('learn')" style="
  width:100px;
  padding:10px;
  margin-top:10px;
  margin-bottom:10px;
  border-radius:999px;
  border:none;
  background: #F56217;
  cursor:pointer;
  font-weight:bold;">Learn</button>
            </div>

            <div id="flashcardArea"></div>

            <div class="flashcard-nav">
                <button onclick="prevFlashcard()" style="
        border:none;
        border-radius:50%;
        width:42px;
        height:42px;
        font-size:20px;
        cursor:pointer;
        background: #0B486B;
            background: linear-gradient(5deg,
                    #0B486B, #F56217);
        color:black; margin-top: 5px;">‚óÄ</button>
                <span id="flashcardCounter"></span>
                <button onclick="nextFlashcard()" style="
        border:none;
        border-radius:50%;
        width:42px;
        height:42px;
        font-size:20px;
        cursor:pointer;
        background: #0B486B;
            background: linear-gradient(5deg,
                    #0B486B, #F56217);
        color:black; margin-top: 5px;">‚ñ∂</button>
            </div>

        </div>
    </div>

    <div id="achievementPopup" class="overlay hidden">
        <div style="
    background:#111;
    padding:40px;
    border-radius:20px;
    text-align:center;
    box-shadow:0 0 40px gold;
    animation: popIn 0.4s ease-out;
  ">
            <div style="font-size:5rem;">üèÜ</div>
            <div id="achievementTitle" style="font-size:1.8rem;margin-top:10px;"></div>
            <div id="achievementDesc" style="font-size:1rem;opacity:0.85;margin-top:6px;"></div>
        </div>
    </div>
    <div id="replayOverlay" class="overlay hidden" style="position: absolute; top: 0;">
        <div style="background:#111;padding:20px;border-radius:16px;width:90%;max-width:800px;">
            <h2 style="font-size: 3rem;">Session Replay</h2>
            <canvas id="speedChart" width="720px" height="360px"></canvas>
            <div id="answerTimeline"></div>
            <button onclick="closeReplay()" style="
  width:100%;
  padding:10px;
  margin-top:10px;
  margin-bottom:20px;
  border-radius:999px;
  border:none;
  background: #F56217;
  cursor:pointer;
  font-weight:bold;">Done</button>
        </div>
    </div>
    <div class="snoopy"><img
            src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExYWZ1cjU5ZnJ6cThjcjc2YWxoZmJsZXh2Z2xxOGZjbGlsaG42YWtjNyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/rgq4Sar77s85W/giphy.gif"
            alt="" width=200px></div>
    <div class="honse">
        <img src="https://media.tenor.com/hFZPT9vXz-wAAAAM/horse-funny-horse.gif" alt="">
    </div>
    <div class="quiz-container" style="position: relative;">
        <img src="images/pjhat.jpg" alt="pjhat" class="pjhat">
        <h1><img id="logo" src="images/Pahoot!.PNG" alt="" width=75%></h1>
        <button id="settingsBtn" style="
        position:absolute;
        top:16px;
        right:16px;
        border:none;
        border-radius:50%;
        width:42px;
        height:42px;
        font-size:20px;
        cursor:pointer;
        background: #0B486B;
            background: linear-gradient(5deg,
                    #0B486B, #F56217);
        color:black;">
            ‚öôÔ∏è
        </button>
        <button id="drawerBtn" style="
  position:absolute;
  top:16px;
  left:16px;
  border:none;
  border-radius:50%;
  width:42px;
  height:42px;
  font-size:20px;
  cursor:pointer;
  background:linear-gradient(5deg,#0B486B,#F56217);
">
            ‚ò∞
        </button>
        <button onclick="enterFlashcards()" style="
        position:absolute;
        top: 14rem;
        left:16px;
        border:none;
        border-radius:50%;
        width:42px;
        height:42px;
        font-size:20px;
        cursor:pointer;
        background: #0B486B;
            background: linear-gradient(5deg,
                    #0B486B, #F56217);
        color:black;">üìö</button>


        <button id="retryMissedBtn" class="hidden" style="
  width:100%;
  padding:10px;
  margin-top:10px;
  margin-bottom:10px;
  border-radius:999px;
  border:none;
  background: #F56217;
  cursor:pointer;
  font-weight:bold;">
            üîÅ Retry Missed Questions
        </button>
        <button id="replayBtn" class="hidden" style="
  width:100%;
  padding:10px;
  margin-top:10px;
  margin-bottom:10px;
  border-radius:999px;
  border:none;
  background: #F56217;
  cursor:pointer;
  font-weight:bold;">üìä Session Replay</button>

        <div id="hud">
            <span id="hudLeft">Q 1 ‚Ä¢ 0 pts</span>
            <div id="hudMeters">
                <div class="mini brain"></div>
                <div class="mini streak"></div>
            </div>
            <span id="timer" class="hidden">‚è± 3.0</span>
        </div>

        <div class="question" id="question">Loading...</div>
        <div class="answers">
            <button class="answer red" data-index="0"></button>
            <button class="answer blue" data-index="1"></button>
            <button class="answer yellow" data-index="2"></button>
            <button class="answer green" data-index="3"></button>
        </div>
        <input id="typedAnswer" class="hidden" placeholder="Type your answer..." style="
    width:100%;
    padding:14px;
    border-radius:999px;
    border:none;
    font-size:1.1rem;
    text-align:center;
    ">

        <div class="result hidden" id="result"></div>
    </div>

    <div id="achievementTicker">
        <div id="achievementTrack"></div>
    </div>


    <script>
        function playSound(id) {
            const sound = document.getElementById(id);
            if (!sound) return;
            sound.currentTime = 0;
            sound.play().catch(() => { });
        }

        // Globals

        let questions = [];
        let current = 0;
        let score = 0;
        let streak = 0;
        let endlessMode = false;
        let hyperMode = false;
        let timer = false;
        let timeLeft = 5.0;
        let hyperTimeLimit = 3;
        let timerInterval = null;
        let lockinMode = false;
        const DEFAULT_DECK = 'questions/AnimalNutritionFinalFocused2.json';
        let currentDeck = DEFAULT_DECK;
        const DECKS = [
            {
                label: "Animal and Human Physiology Exam 4",
                value: "questions/PhysiologyExam4.json"
            },
            {
                label: "Best Animal Nutrition Final Study Deck",
                value: "questions/AnimalNutritionFinalFocused2.json"
            },
            {
                label: "Animal Nutrition Final",
                value: "questions/AnimalNutritionFinal.json"
            },
            {
                label: "Focused Animal Nutrition Final",
                value: "questions/AnimalNutritionFinalFocused.json"
            }

        ];
        const MAX_STREAK_FOR_FULL = 10;
        let quizMode = 'normal';      // normal | endless | hyper
        let answerTypeConfig = {
            mc: true,
            typed: false,
            tf: false
        };
        let wrongQuestions = [];
        let answerBias = {
            indexCount: [0, 0, 0, 0],
            correctCount: 0,
            totalAnswers: 0
        };
        let cognitiveLoad = 0; // 0‚Äì100
        let answerStartTime = 0;
        let recentResults = []; // true/false history
        let sessionStart = Date.now();
        let sessionReplay = [];
        let flashcardMode = false;
        let flashcardIndex = 0;
        let flashcardSubMode = "carousel"; // "carousel" | "learn"
        let flashcards = [];
        let flashcardFlipped = false;
        const LOAD_DECAY = 0.92; // recovery rate

        const ACHIEVEMENTS = {
            first_correct: {
                title: "First Blood",
                desc: "Get your first correct answer",
                icon: "üèÜ"
            },
            streak_5: {
                title: "Heating Up",
                desc: "5 correct in a row",
                icon: "üî•",
                color: "Yellow"
            },
            streak_10: {
                title: "On Fire",
                desc: "10 streak",
                icon: "üöÄ",
                color: "Orange"
            },
            hyper_survivor: {
                title: "Hyper Survivor",
                desc: "Answer 10 in Hyper Mode",
                icon: "üíÄ"
            },
            perfect_deck: {
                title: "Flawless Victory",
                desc: "Finish a deck with no wrong answers",
                icon: "üíé",
                color: "Red"
            },
            dev_mode: {
                title: "Reality Breaker",
                desc: "Activated developer mode",
                icon: "üß™",
                color: "Purple"
            },
            anti_pattern: {
                title: "Mindful Thinker",
                desc: "Broke an answer-selection habit",
                icon: "üß†",
                color: "Cyan"
            },
            eepy: {
                title: "You should get some rest",
                desc: "Go to bed",
                icon: "üò¥"
            }
        };
        const ACHIEVEMENT_THEMES = {
            streak_10: 'theme-fire',
            perfect_deck: 'theme-diamond',
            hyper_survivor: 'theme-chaos',
            dev_mode: 'theme-matrix',
            eepy: 'theme-eepy'
        };



        // local storage keys
        const DECK_KEY = 'pahootDeck';
        const SETTINGS_KEY = 'pahootSettings';
        const ACHIEVEMENTS_KEY = 'pahootAchievements';
        const THEMES_KEY = 'pahootThemes';
        let settings = {
            hideMascots: true,
            hyperTime: 5,
            darkMode: false,
            lockinMode: false,
            hideAchievements: false,
            theme: "default",
            voiceMode: false
        };

        let unlockedAchievements = JSON.parse(localStorage.getItem(ACHIEVEMENTS_KEY)) || {};
        let unlockedThemes = JSON.parse(localStorage.getItem(THEMES_KEY)) || {};

        //dev_mode() function for loading the test deck
        window.dev_mode = function () {
            const TEST_DECK = 'test.json';

            console.warn('‚ö†Ô∏è DEV MODE ENABLED');
            unlockAchievement('dev_mode');

            currentDeck = TEST_DECK;

            endlessMode = true;
            hyperMode = false;
            document.body.classList.remove('hypermode');

            current = 0;
            score = 0;
            streak = 0;
            updateStreakMeter();

            syncDrawerUI();
            loadQuestions(currentDeck);
            updateHUD();
        };

        window.dev_CLR_ACHIEVE = function () {
            localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify({}));
            unlockedAchievements = null;
            localStorage.setItem(THEMES_KEY, JSON.stringify({}));
            unlockedThemes = null;
        }

        // Helpers

        document.addEventListener('keydown', function (event) {
            if (flashcardMode) {
                if (event.key === ' ') {
                    event.preventDefault();
                    flipFlashcard();
                }
                if (event.key === "ArrowRight") {
                    nextFlashcard();
                }
                if (event.key === "ArrowLeft") {
                    prevFlashcard();
                }
            }
        })

        function enterFlashcards() {
            flashcardMode = true;
            flashcards = [...questions];
            flashcardIndex = 0;
            flashcardFlipped = false;

            document.getElementById("flashcardOverlay").classList.remove("hidden");
            renderFlashcard();
        }

        function exitFlashcards() {
            flashcardMode = false;
            document.getElementById("flashcardOverlay").classList.add("hidden");
        }

        function renderFlashcard() {
            const q = flashcards[flashcardIndex];
            const front = q.question;
            const back = q.choices[q.correct];
            const area = document.getElementById("flashcardArea");

            document.getElementById("flashcardCounter").textContent =
                `${flashcardIndex + 1} / ${flashcards.length}`;

            if (flashcardSubMode === "learn") {
                renderLearnCard(front, back, area);
            } else {
                renderCarouselCard(front, back, area);
            }
        }


        function renderCarouselCard(front, back, area) {
            area.innerHTML = `
    <div class="flashcard ${flashcardFlipped ? "flipped" : ""}"
         onclick="flipFlashcard()">
      <div class="flashcard-inner">
        <div class="flashcard-face flashcard-front">
          <div class="card-label">QUESTION</div>
          <div class="card-text">${front}</div>
        </div>
        <div class="flashcard-face flashcard-back">
          <div class="card-label">ANSWER</div>
          <div class="card-text">${back}</div>
        </div>
      </div>
    </div>
  `;
        }

        function renderLearnCard(front, back, area) {
            area.innerHTML = `
    <div class="flashcard learn">
      <div class="flashcard-face flashcard-front">
        <div class="card-label">QUESTION</div>
        <div class="card-text">${front}</div>

        <input id="learnInput"
               placeholder="Type your answer‚Ä¶"
               autocomplete="off" />

        <button class="gradient-btn"
                onclick="revealLearnAnswer('${back.replace(/'/g, "\\'")}')">
          Reveal Answer
        </button>
      </div>
    </div>
  `;
        }

        function revealLearnAnswer(answer) {
            const area = document.getElementById("flashcardArea");
            area.innerHTML += `
    <div class="learn-reveal">
      <div class="card-label">ANSWER</div>
      <div class="card-text">${answer}</div>
    </div>
  `;
        }



        function flipFlashcard() {
            flashcardFlipped = !flashcardFlipped;
            renderFlashcard();
        }

        function nextFlashcard() {
            flashcardIndex = (flashcardIndex + 1) % flashcards.length;
            flashcardFlipped = false;
            renderFlashcard();
        }

        function prevFlashcard() {
            flashcardIndex =
                (flashcardIndex - 1 + flashcards.length) % flashcards.length;
            flashcardFlipped = false;
            renderFlashcard();
        }

        function setFlashcardMode(mode) {
            flashcardSubMode = mode;
            flashcardFlipped = false;
            renderFlashcard();
        }

        function checkLearnAnswer() {
            const q = flashcards[flashcardIndex];
            const input = document.getElementById("learnInput").value.toLowerCase();
            const correct = q.choices[q.correct].toLowerCase();

            const similarity = input.includes(correct) || correct.includes(input);

            alert(similarity ? "Nice!" : `Answer: ${q.choices[q.correct]}`);
        }

        function speak(text, rate = 1, pitch = 1) {
            if (!settings.voiceMode) return;
            const msg = new SpeechSynthesisUtterance(text);
            msg.rate = rate;
            msg.pitch = pitch;
            speechSynthesis.cancel();
            speechSynthesis.speak(msg);
        }


        function openReplay() {
            const data = JSON.parse(localStorage.getItem('pahootLastSession'));
            if (!data) return;

            drawSpeedGraph(
                document.getElementById('speedChart'),
                data
            );
            renderTimeline(data);

            document.getElementById('replayOverlay').classList.remove('hidden');
        }

        function closeReplay() {
            document.getElementById('replayOverlay').classList.add('hidden');
        }


        function drawSpeedGraph(canvas, data) {
            const ctx = canvas.getContext('2d');
            const padding = 40; // space for axes
            const width = canvas.width;
            const height = canvas.height;

            ctx.fillStyle = 'white';
            ctx.font = '20px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText('Speed vs. Question', width / 2, 10);

            ctx.clearRect(0, 0, width, height);

            // Determine max response time for scaling
            const max = Math.max(...data.map(d => d.responseTime));

            // Draw axes
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;

            // Y-axis
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();

            // X-axis
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Draw Y-axis labels (optional: 5 ticks)
            ctx.fillStyle = 'white';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            const numTicks = 5;
            for (let i = 0; i <= numTicks; i++) {
                const y = padding + (height - 2 * padding) * i / numTicks;
                const value = Math.round(max * (1 - i / numTicks));
                ctx.fillText(value, padding - 5, y);
                // Optional: draw horizontal grid line
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            // Draw the line chart
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.beginPath();

            data.forEach((d, i) => {
                const x = padding + (i * (width - 2 * padding) / (data.length - 1));
                const y = height - padding - (d.responseTime / max) * (height - 2 * padding);
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // Optional: draw points
            ctx.fillStyle = 'white';
            data.forEach((d, i) => {
                const x = padding + (i * (width - 2 * padding) / (data.length - 1));
                const y = height - padding - (d.responseTime / max) * (height - 2 * padding);
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });
        }



        function renderTimeline(data) {
            const el = document.getElementById('answerTimeline');
            el.innerHTML = '';

            data.forEach(d => {
                const row = document.createElement('div');
                row.style.fontSize = "2rem";
                row.textContent =
                    `${d.correct ? '‚úÖ' : '‚ùå'} ${d.responseTime.toFixed(2)}s`;
                el.appendChild(row);
            });
        }


        function endQuiz() {
            if (wrongQuestions.length === 0) {
                unlockAchievement('perfect_deck');
            }

            localStorage.setItem(
                'pahootLastSession',
                JSON.stringify(sessionReplay)
            );
            localStorage.setItem(
                'pahootSessionHistory',
                JSON.stringify([
                    ...(JSON.parse(localStorage.getItem('pahootSessionHistory')) || []),
                    sessionReplay
                ].slice(-10)) // keep last 10
            );


            playSound('endSound');
            document.querySelector('.answers').classList.add('hidden');
            document.getElementById('question').textContent = 'Quiz Finished!';
            document.getElementById('hudLeft').classList.add('hidden');
            document.getElementById('hudMeters').classList.add('hidden');
            document.getElementById('replayBtn').classList.toggle('hidden');

            const result = document.getElementById('result');
            result.textContent = `Final Score: ${score} / ${questions.length}`;
            result.classList.remove('hidden');

            document.getElementById('retryMissedBtn').classList.toggle(
                'hidden',
                wrongQuestions.length === 0
            );
        }


        function resetGame({ resetScore = true } = {}) {
            current = 0;
            streak = 0;

            if (resetScore) score = 0;

            wrongQuestions = [];
            updateStreakMeter();
            updateHUD();
        }


        function applyTheme(theme) {
            // Remove ONLY achievement themes
            Object.values(ACHIEVEMENT_THEMES).forEach(t =>
                document.body.classList.remove(t)
            );

            if (theme && theme !== 'default') {
                document.body.classList.add(theme);
            }
        }


        function renderThemeOptions() {
            const select = document.getElementById("themeSelect");
            if (!select) return;

            select.innerHTML = '<option value="default">Default</option>';

            Object.keys(unlockedThemes || {}).forEach(themeClass => {
                const opt = document.createElement("option");
                opt.value = themeClass;
                opt.textContent = themeClass
                    .replace('theme-', '')
                    .replace(/-/g, ' ')
                    .toUpperCase();
                select.appendChild(opt);
            });

            select.value = settings.theme || "default";
        }


        function updateHUD() {
            const hudLeft = document.getElementById('hudLeft');
            if (!hudLeft) return;

            const qNum = endlessMode
                ? `Endless`
                : `Q ${Math.min(current + 1, questions.length)}/${questions.length}`;

            hudLeft.textContent = `${qNum} ‚Ä¢ ${score} pts`;
        }


        function syncQuestionTypeUI() {
            document.getElementById('typeMC').checked = answerTypeConfig.mc;
            document.getElementById('typeTyped').checked = answerTypeConfig.typed;
            document.getElementById('typeTF').checked = answerTypeConfig.tf;
        }

        ['typeMC', 'typeTyped', 'typeTF'].forEach(id => {
            document.getElementById(id).onchange = () => {
                answerTypeConfig.mc = document.getElementById('typeMC').checked;
                answerTypeConfig.typed = document.getElementById('typeTyped').checked;
                answerTypeConfig.tf = document.getElementById('typeTF').checked;

                // prevent all-off state
                if (!getActiveAnswerTypes().length) {
                    answerTypeConfig.mc = true;
                    document.getElementById('typeMC').checked = true;
                }
            };
        });


        function getActiveAnswerTypes() {
            return Object.entries(answerTypeConfig)
                .filter(([_, enabled]) => enabled)
                .map(([type]) => type);
        }

        function pickAnswerType() {
            const types = getActiveAnswerTypes();
            if (types.length === 0) return 'mc'; // safety fallback
            if (streak >= 6 && answerTypeConfig.typed) return 'typed';
            if (streak >= 4 && answerTypeConfig.tf) return 'tf';
            return types[Math.floor(Math.random() * types.length)];
        }


        function updateCognitiveLoad(isCorrect) {
            const now = performance.now();
            const responseTime = (now - answerStartTime) / 1000;

            // Decay previous load slightly
            cognitiveLoad *= LOAD_DECAY;

            // Slow answers increase load
            if (responseTime > 4) cognitiveLoad += (responseTime - 4) * 2;

            // Wrong answers spike load
            if (!isCorrect) cognitiveLoad += 4;

            // Track recent answers
            recentResults.push(isCorrect);
            if (recentResults.length > 6) recentResults.shift();

            // Error clustering
            const recentWrong = recentResults.filter(r => !r).length;
            if (recentWrong >= 3) cognitiveLoad += 10;

            // Long session pressure
            const minutesPlayed = (Date.now() - sessionStart) / 60000;
            if (minutesPlayed > 15) cognitiveLoad += 0.5;

            // Clamp
            cognitiveLoad = Math.min(100, Math.max(0, cognitiveLoad));

            applyCognitiveEffects();
        }

        function applyCognitiveEffects() {
            // Visual cue (subtle)
            document.body.style.filter =
                `saturate(${1 - cognitiveLoad / 200})
         brightness(${1 - cognitiveLoad / 300})`;

            // pre cleanup logic
            // document.getElementById('brainFill').style.width =
            //     `${cognitiveLoad}%`;
            document.querySelector('.mini.brain').style.setProperty('--fill', cognitiveLoad + '%');

            // Hypermode mercy
            if (hyperMode && cognitiveLoad > 75) {
                hyperTimeLimit += 0.5;
            }

            // Soft warning (no modal spam)
            if (cognitiveLoad > 85 && !hyperMode && !document.getElementById('hudLeft').textContent.includes('FATIGUE')) {
                document.getElementById('hudLeft').textContent += ' ‚Ä¢ üß† FATIGUE';
                unlockAchievement('eepy')
            }

            // Lock-in override (optional)
            if (settings.lockinMode && cognitiveLoad > 90) {
                document.body.classList.remove('lockin');
            }
        }


        function showBiasWarning(bias) {
            const msgs = [
                "‚ö†Ô∏è Try reading all answers!",
                "üß† Pattern detected ‚Äî mix it up!",
                "üëÄ Answers are shuffled for a reason!",
                "üéØ Don't trust muscle memory!"
            ];

            const hint = document.createElement('div');
            hint.style.position = 'absolute';
            hint.style.bottom = '60px';
            hint.style.left = '50%';
            hint.style.transform = 'translateX(-50%)';
            hint.style.padding = '10px 18px';
            hint.style.borderRadius = '999px';
            hint.style.background = 'rgba(0,0,0,0.85)';
            hint.style.fontSize = '14px';
            hint.style.opacity = '0.95';
            hint.textContent = msgs[Math.floor(Math.random() * msgs.length)];

            document.querySelector('.quiz-container').appendChild(hint);
            setTimeout(() => hint.remove(), 1800);
        }


        function detectBias() {
            if (answerBias.totalAnswers < 6) return null;

            const maxIndex = Math.max(...answerBias.indexCount);
            const dominantIndex = answerBias.indexCount.indexOf(maxIndex);

            if (maxIndex / answerBias.totalAnswers > 0.55) {
                return {
                    type: 'position',
                    index: dominantIndex
                };
            }

            return null;
        }


        function shuffleChoices(choices, correctIndex) {
            const mapped = choices.map((text, index) => ({
                text,
                isCorrect: index === correctIndex
            }));

            for (let i = mapped.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [mapped[i], mapped[j]] = [mapped[j], mapped[i]];
            }

            return mapped;
        }


        function renderAchievementTicker() {
            const ticker = document.getElementById('achievementTicker');
            const track = document.getElementById('achievementTrack');

            if (!ticker || !track) return;

            track.innerHTML = '';

            const unlockedIds = Object.keys(unlockedAchievements || {});

            if (unlockedIds.length === 0) {
                const empty = document.createElement('span');
                empty.style.opacity = '0.5';
                empty.textContent = 'No achievements yet';
                track.appendChild(empty);
                return;
            }

            unlockedIds.forEach(id => {
                const ach = ACHIEVEMENTS[id];
                if (!ach) return;

                const item = document.createElement('span');
                item.className = 'achievement-item unlocked';
                item.textContent = `${ach.icon} ${ach.title}`;
                if (ach.color) {
                    item.style.color = ach.color;
                }

                track.appendChild(item);
            });
        }



        function showAchievementPopup(ach) {
            const popup = document.createElement('div');
            popup.className = 'overlay';
            let unlockedTheme = null;
            const achKey = Object.keys(ACHIEVEMENTS).find(key => ACHIEVEMENTS[key] === ach);

            if (achKey && ACHIEVEMENT_THEMES[achKey]) {
                unlockedTheme = ACHIEVEMENT_THEMES[achKey];
            }
            const themeDiv = `<div style="font-size:1rem;">You've unlocked ${unlockedTheme}! Change your theme in settings.</div>`
            popup.innerHTML = `
    <div style="text-align:center; padding: 10px;">
      <div style="font-size:5rem;">üèÜ</div>
      <div style="font-size:2rem;">${ach.title}</div>
      <div style="font-size:1rem;">${ach.desc}</div>
      ${unlockedTheme ? themeDiv : ""}
    </div>
  `;
            popup.firstElementChild.style.boxShadow =
                ach.color ? `0 0 40px ${ach.color}` : '0 0 40px gold';
            document.querySelector('.quiz-container').appendChild(popup);

            setTimeout(() => popup.remove(), 3500);
        }



        function unlockAchievement(id) {
            if (unlockedAchievements[id]) return;

            const ach = ACHIEVEMENTS[id];
            if (!ach) return;

            unlockedAchievements[id] = true;
            localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify(unlockedAchievements));

            const theme = ACHIEVEMENT_THEMES[id];
            console.log(theme);
            if (theme) {
                unlockedThemes[theme] = true;
                localStorage.setItem(THEMES_KEY, JSON.stringify(unlockedThemes));

                settings.theme = theme;
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));

                applyTheme(theme);
                renderThemeOptions(); // üî• THIS WAS MISSING
            }

            renderAchievementTicker();
            if (!hyperMode) showAchievementPopup(ach);
        }





        function updateStreakMeter() {
            if (streak === 5) speak("You're on fire!", 1.2);
            if (streak === 10) speak("Unstoppable!", 1.2);
            document.querySelector('.mini.streak').style.setProperty('--fill', streak / 10 * 100 + '%');
        }

        function applySettings() {
            // Mascots
            document.querySelector('.snoopy').style.display =
                settings.hideMascots ? 'none' : '';
            document.querySelector('.honse').style.display =
                settings.hideMascots ? 'none' : '';

            // Hyper timer
            hyperTimeLimit = settings.hyperTime;

            // Dark mode (non-hyper only)
            if (!hyperMode) {
                document.body.classList.toggle('darkmode', settings.darkMode);
            }

            // Lock-in mode
            document.body.classList.toggle('lockin', settings.lockinMode);

            // Achievements ticker
            const ticker = document.getElementById('achievementTicker');
            ticker.classList.toggle('hidden', settings.hideAchievements);

            // Themes
            applyTheme(settings.theme);




            // Sync UI
            document.getElementById('hideMascots').checked = settings.hideMascots;
            document.getElementById('hyperTime').value = settings.hyperTime;
            document.getElementById('darkMode').checked = settings.darkMode;
            document.getElementById('lockinMode').checked = settings.lockinMode;
            document.getElementById('hideAchievements').checked = settings.hideAchievements;
            document.getElementById('themeSelect').value = settings.theme;
            document.getElementById('voiceMode').checked = settings.voiceMode;

        }

        function saveSettings() {
            settings.hideMascots = document.getElementById('hideMascots').checked;
            settings.hyperTime = document.getElementById('hyperTime').value;
            settings.darkMode = document.getElementById('darkMode').checked;
            settings.lockinMode = document.getElementById('lockinMode').checked;
            settings.hideAchievements = document.getElementById('hideAchievements').checked;
            settings.theme = document.getElementById('themeSelect').value;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            settings.voiceMode = document.getElementById("voiceMode").checked;

            applySettings();
        }

        document.getElementById('lockinMode').onchange = e => {
            lockinMode = e.target.checked;
            document.body.classList.toggle('lockin', lockinMode);
        };

        document.getElementById('darkMode').onchange = e => {
            if (!hyperMode) {
                document.body.classList.toggle('darkmode', e.target.checked);
            }
        };


        document.getElementById('settingsBtn').onclick = () => {
            playSound('toggleSound');
            document.getElementById('settingsOverlay').classList.remove('hidden');
        };

        document.getElementById('drawerBtn').onclick = () => {
            playSound('toggleSound');
            syncDrawerUI();
            document.getElementById('controlDrawer').classList.remove('hidden');
        };

        document.getElementById('closeSettings').onclick = () => {
            playSound('toggleSound');
            document.getElementById('settingsOverlay').classList.add('hidden');
            saveSettings();
        };

        document.getElementById('closeDrawer').onclick = () => {
            playSound('toggleSound');
            document.getElementById('controlDrawer').classList.add('hidden');
        };

        document.getElementById('hideMascots').onchange = e => {
            document.querySelector('.snoopy').style.display = e.target.checked ? 'none' : '';
            document.querySelector('.honse').style.display = e.target.checked ? 'none' : '';
        };

        function startTimer() {
            clearInterval(timerInterval);
            const base = parseFloat(document.getElementById('hyperTime').value) || 3;
            hyperTimeLimit = Math.max(1.2, base - Math.floor(streak / 4) * 0.25);

            timeLeft = hyperTimeLimit;

            const timerEl = document.getElementById('timer');
            timerEl.classList.remove('hidden');
            timerEl.textContent = `‚è± ${timeLeft.toFixed(1)}`;

            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                if (hyperMode) {
                    const pulseRate = Math.max(0.4, 1 - streak * 0.05);
                    if (Math.abs(timeLeft % pulseRate) < 0.05) {
                        playSound('bassSound');
                    }



                    const urgency = Math.max(0, hyperTimeLimit - timeLeft);
                    document.body.style.filter = `
                        brightness(${1 + urgency * 0.18})
                        contrast(${1 + urgency * 0.12})
                        saturate(${1 + urgency * 0.2})
                    `;

                }


                timerEl.textContent = `‚è± ${timeLeft.toFixed(1)}`;
                if (hyperMode && timeLeft < 1.5 && timeLeft > 1.4) {
                    speak("HURRY UP", 1.5, 1.8);
                }


                if (timeLeft <= 0) {
                    document.body.classList.add('screen-tear');
                    setTimeout(() => document.body.classList.remove('screen-tear'), 200);
                    clearInterval(timerInterval);
                    playSound('wrongSound');
                    const q = questions[current];
                    showWrong(q.choices[q.correct]);
                    setTimeout(() => {
                        current++;
                        showQuestion();
                    }, 2000);
                }
            }, 100);
        }

        async function loadQuestions(deck = currentDeck) {
            const res = await fetch(deck);
            questions = await res.json();
            questions = shuffleArray(questions);

            resetGame({ resetScore: true });
            showQuestion();
        }

        document.getElementById('replayBtn').onclick = () => {
            playSound('toggleSound');

            openReplay();
        }

        document.getElementById('retryMissedBtn').onclick = () => {
            playSound('toggleSound');

            questions = shuffleArray([...wrongQuestions]);
            wrongQuestions = [];

            current = 0;
            score = 0;
            streak = 0;

            document.getElementById('retryMissedBtn').classList.add('hidden');
            showQuestion();
        };

        function resolveDeck(savedDeck) {
            // const select = document.getElementById('testSelect');
            const options = [...select.options].map(o => o.value);

            if (savedDeck && options.includes(savedDeck)) {
                return savedDeck;
            }

            return DEFAULT_DECK;
        }

        document.getElementById('drawerDeckSelect').onchange = e => {
            playSound('toggleSound');

            currentDeck = e.target.value;
            localStorage.setItem(DECK_KEY, currentDeck);

            endlessMode = false;
            hyperMode = false;
            document.body.classList.remove('hypermode');

            current = 0;
            score = 0;
            streak = 0;
            updateStreakMeter();

            loadQuestions(currentDeck);
        };

        document.getElementById('drawerEndlessToggle').onchange = e => {
            let sessionReplay = [];
            endlessMode = e.target.checked;

            if (!endlessMode) {
                hyperMode = false;
                document.body.classList.remove('hypermode');
            }

            resetGame({ resetScore: true });
            showQuestion();
        };


        document.getElementById('drawerHyperToggle').onchange = e => {
            hyperMode = e.target.checked;
            endlessMode = hyperMode;

            document.body.classList.toggle('hypermode', hyperMode);

            resetGame({ resetScore: true });
            showQuestion();
        };



        document.getElementById('drawerFullscreenBtn').onclick = () => {
            playSound('toggleSound');
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        };


        function syncDrawerUI() {
            syncQuestionTypeUI();

            const drawerSelect = document.getElementById('drawerDeckSelect');
            if (!drawerSelect) return;

            drawerSelect.innerHTML = '';

            DECKS.forEach(deck => {
                const opt = document.createElement('option');
                opt.value = deck.value;
                opt.textContent = deck.label;
                drawerSelect.appendChild(opt);
            });

            drawerSelect.value = currentDeck;

            document.getElementById('drawerEndlessToggle').checked = endlessMode;
            document.getElementById('drawerHyperToggle').checked = hyperMode;
        }


        document.addEventListener('DOMContentLoaded', () => {
            // Deck
            const savedDeck = localStorage.getItem(DECK_KEY);
            currentDeck = DECKS.some(d => d.value === savedDeck)
                ? savedDeck
                : DEFAULT_DECK;

            // Settings
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            if (savedSettings) settings = JSON.parse(savedSettings);

            // Achievements & themes
            const savedAchievements = localStorage.getItem(ACHIEVEMENTS_KEY);
            if (savedAchievements) unlockedAchievements = JSON.parse(savedAchievements);

            const savedThemes = localStorage.getItem(THEMES_KEY);
            if (savedThemes) unlockedThemes = JSON.parse(savedThemes);

            applySettings();
            renderThemeOptions();
            renderAchievementTicker();
            syncDrawerUI();

            loadQuestions(currentDeck);
        });


        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) {
            settings = JSON.parse(saved);
        }
        applySettings();
        endlessMode = false;
        hyperMode = false;

        document.querySelectorAll('audio').forEach(a => {
            a.volume = 0.9;
        });

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function showQuestion() {
            answerStartTime = performance.now();
            updateHUD();

            if (current >= questions.length) {
                if (endlessMode) {
                    questions = shuffleArray(questions);
                    current = 0;
                } else {
                    endQuiz();
                    return;
                }
            }
            const q = questions[current];
            console.log(q);
            const currentAnswerType = pickAnswerType();


            document.body.style.filter = "";

            document.getElementById('question').textContent = q.question;

            clearInterval(timerInterval);

            speak(q.question, hyperMode ? 2 : 1);


            if (hyperMode) {
                startTimer();
            } else {
                document.getElementById('timer').classList.add('hidden');
            }


            if (currentAnswerType === 'mc') {
                document.querySelector('.answers').classList.remove('hidden');
                document.getElementById('typedAnswer').classList.add('hidden');


                const shuffled = shuffleChoices(q.choices, q.correct);

                document.querySelectorAll('.answer').forEach((btn, i) => {
                    btn.classList.remove('hidden');
                    btn.textContent = shuffled[i].text;
                    btn.onclick = () => {
                        answerBias.indexCount[i]++;
                        selectAnswer(shuffled[i].isCorrect);
                    };
                });
            }
            if (currentAnswerType === 'typed') {
                document.querySelector('.answers').classList.add('hidden');

                const input = document.getElementById('typedAnswer');
                input.classList.remove('hidden');
                input.value = '';
                input.focus();

                input.onkeydown = e => {
                    if (e.key === 'Enter') {
                        const correct =
                            input.value.trim().toLowerCase() ===
                            q.choices[q.correct].toLowerCase();

                        handleAnswer(correct);
                    }
                };
            }
            if (currentAnswerType === 'tf') {
                document.querySelector('.answers').classList.remove('hidden');
                document.getElementById('typedAnswer').classList.add('hidden');

                const isTrue = Math.random() > 0.5;
                const displayedAnswer = isTrue
                    ? q.choices[q.correct]
                    : q.choices[(q.correct + 1) % q.choices.length];

                document.getElementById('question').textContent =
                    `Q: ${q.question}\n\n A: "${displayedAnswer}"`;

                const buttons = document.querySelectorAll('.answer');
                buttons[0].textContent = 'TRUE';
                buttons[1].textContent = 'FALSE';
                buttons[2].classList.add('hidden');
                buttons[3].classList.add('hidden');

                buttons[0].onclick = () => handleAnswer(isTrue);
                buttons[1].onclick = () => handleAnswer(!isTrue);
            }

            answerStartTime = performance.now();

        }

        function selectAnswer(isCorrect) {
            updateHUD();
            answerBias.totalAnswers++;
            updateCognitiveLoad(isCorrect);
            clearInterval(timerInterval);
            document.body.style.filter = "";
            const q = questions[current];


            if (isCorrect) {
                playSound('correctSound');
                document.getElementById('question').textContent = 'Correct!';
                score++;
                streak++;
                updateStreakMeter();
                // playSound('confettiSound');
                showConfetti();
                if (score === 1) unlockAchievement('first_correct');
                if (streak === 5) unlockAchievement('streak_5');
                if (streak === 10) unlockAchievement('streak_10');
                if (hyperMode && streak >= 5) unlockAchievement('hyper_survivor');

                document.querySelector('.quiz-container').style.boxShadow =
                    `0 0 ${20 + streak * 100}px rgba(255,0,255,${streak / (streak + 10)})`;
            } else {
                wrongQuestions.push(questions[current]);
                streak = 0;
                updateStreakMeter();
                playSound('wrongSound');
                const correctText = q.choices[q.correct];
                showWrong(correctText);
                document.querySelector('.quiz-container').style.boxShadow =
                    `0 10px 25px rgba(0,0,0,0.4)`;
            }

            const bias = detectBias();
            if (bias && !hyperMode) {
                showBiasWarning(bias);
            }

            setTimeout(() => {
                sessionReplay.push({
                    index: current,
                    question: questions[current].question,
                    correct: isCorrect,
                    responseTime: (performance.now() - answerStartTime) / 1000,
                    cognitiveLoad: cognitiveLoad,
                    streakAtAnswer: streak,
                    mode: hyperMode ? 'hyper' : endlessMode ? 'endless' : 'normal',
                    timestamp: Date.now()
                });
                current++;
                showQuestion();
            }, isCorrect ? 3000 : 2000);
        }

        function handleAnswer(correct) {
            updateHUD();
            answerBias.totalAnswers++;
            clearInterval(timerInterval);
            updateCognitiveLoad(isCorrect);


            if (correct) {
                score++;
                streak++;
                playSound('correctSound');
                showConfetti();
            } else {
                wrongQuestions.push(questions[current]);
                streak = 0;
                playSound('wrongSound');
                showWrong(questions[current].choices[questions[current].correct]);
            }

            updateStreakMeter();

            setTimeout(() => {
                sessionReplay.push({
                    index: current,
                    question: questions[current].question,
                    correct: isCorrect,
                    responseTime: (performance.now() - answerStartTime) / 1000,
                    cognitiveLoad: cognitiveLoad,
                    streakAtAnswer: streak,
                    mode: hyperMode ? 'hyper' : endlessMode ? 'endless' : 'normal',
                    timestamp: Date.now()
                });
                current++;
                showQuestion();
            }, 1800);
        }


        function showWrong(correctAnswer) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.innerHTML = `
            <div style="text-align:center;">
                <div style="font-size:4rem;">WRONG</div>
                <div style="font-size:1.8rem; margin-top:10px;">
                    Correct answer:<br>
                    <span style="color:#2ecc71;">${correctAnswer}</span>
                </div>
            </div>
        `;
            document.querySelector('.quiz-container').appendChild(overlay);
            setTimeout(() => overlay.remove(), 2000);
        }

        function showConfetti() {
            const container = document.querySelector('.quiz-container');
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.style.background = 'transparent';

            for (let i = 0; i < 120; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + '%';
                conf.style.top = '-10px'
                conf.style.background = `hsl(${Math.random() * 360},100%,50%)`;
                conf.style.animationDelay = Math.random() * 0.5 + 's';
                overlay.appendChild(conf);
            }

            container.appendChild(overlay);
            setTimeout(() => overlay.remove(), 3000);
        }

        loadQuestions();
    </script>

</body>

</html>